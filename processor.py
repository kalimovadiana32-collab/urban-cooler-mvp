import cv2
import numpy as np

def process_thermal_image(image, base_temp, city_type):
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç OpenCV
    img_array = np.array(image.convert('RGB'))
    img_cv = cv2.cvtColor(img_array, cv2.COLOR_RGB2BGR)
    
    # –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —á/–± –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–æ–≤
    gray = cv2.cvtColor(img_cv, cv2.COLOR_BGR2GRAY)
    
    # –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –°–ï–ì–ú–ï–ù–¢–ê–¶–ò–Ø (–∫–∞–∫ –±—ã–ª–æ —É —Ç–µ–±—è):
    # 1. –í—ã–¥–µ–ª—è–µ–º —Å–∞–º—ã–µ —Å–≤–µ—Ç–ª—ã–µ —É—á–∞—Å—Ç–∫–∏ (–æ–±—ã—á–Ω–æ —ç—Ç–æ –∞—Å—Ñ–∞–ª—å—Ç/–¥–æ—Ä–æ–≥–∏) -> –ö–†–ê–°–ù–´–ô
    _, hot_zones = cv2.threshold(gray, 180, 255, cv2.THRESH_BINARY)
    
    # 2. –í—ã–¥–µ–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ —É—á–∞—Å—Ç–∫–∏ (–ó–î–ê–ù–ò–Ø) -> –û–†–ê–ù–ñ–ï–í–´–ô
    # –≠—Ç–æ –≤—Å—ë, —á—Ç–æ –º–µ–∂–¥—É 110 –∏ 180 –ø–æ —è—Ä–∫–æ—Å—Ç–∏
    building_zones = cv2.inRange(gray, 110, 180)
    
    # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –º–∞—Å–∫—É –∏ —Ä–∞—Å–∫—Ä–∞—à–∏–≤–∞–µ–º –µ—ë –ø–æ —Ç–≤–æ–∏–º –ø—Ä–∞–≤–∏–ª–∞–º
    thermal_mask = np.zeros_like(img_cv)
    
    # –°–ò–ù–ò–ô - —Ñ–æ–Ω –∏ —Ö–æ–ª–æ–¥–Ω—ã–µ –∑–æ–Ω—ã (—Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
    thermal_mask[:] = [180, 50, 0] # –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π
    
    # –û–†–ê–ù–ñ–ï–í–´–ô - –∑–¥–∞–Ω–∏—è
    thermal_mask[building_zones > 0] = [0, 140, 255] # –ß–∏—Å—Ç—ã–π –æ—Ä–∞–Ω–∂–µ–≤—ã–π
    
    # –ö–†–ê–°–ù–´–ô - –∞—Å—Ñ–∞–ª—å—Ç –∏ –∑–æ–Ω—ã –ø–µ—Ä–µ–≥—Ä–µ–≤–∞
    thermal_mask[hot_zones > 0] = [0, 0, 255] # –Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π
    
    # –°–º–µ—à–∏–≤–∞–µ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º –Ω–∞ 70%, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∞ –±—ã–ª–∞ —Å–æ—á–Ω–æ–π, –Ω–æ –∫–æ–Ω—Ç—É—Ä—ã –∑–¥–∞–Ω–∏–π —á–∏—Ç–∞–ª–∏—Å—å
    final_output = cv2.addWeighted(thermal_mask, 0.7, img_cv, 0.3, 0)
    
    # –†–∞—Å—á–µ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
    mult = {"–°—Ç–µ–ø–Ω–æ–π (–ê—Å—Ç–∞–Ω–∞)": 1.3, "–ü—Ä–µ–¥–≥–æ—Ä–Ω—ã–π (–ê–ª–º–∞—Ç—ã)": 1.15}.get(city_type, 1.0)
    avg_temp = base_temp + (np.mean(gray) / 255 * 10 * mult)
    
    return final_output, round(avg_temp, 1)

def get_ai_recommendations(temp_diff):
    return "ü§ñ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –û—Ä–∞–Ω–∂–µ–≤—ã–º –≤—ã–¥–µ–ª–µ–Ω—ã –∑–¥–∞–Ω–∏—è, –∫—Ä–∞—Å–Ω—ã–º ‚Äî –∑–æ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞–≥—Ä–µ–≤–∞ –¥–æ—Ä–æ–∂–Ω—ã—Ö –ø–æ–∫—Ä—ã—Ç–∏–π."
